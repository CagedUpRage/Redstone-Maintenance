<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redstone Maintenance</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Open Sans', Arial, sans-serif;
            background: #f7f7f7;
            min-height: 100vh;
            color: #222;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 16px 16px 16px;
        }

        .header {
            position: sticky;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100;
            background: #ededed;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            border-radius: 0;
            margin-bottom: 36px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 32px;
            min-height: 70px;
        }
        .header-logo {
            height: 38px;
            width: auto;
            display: block;
            margin-left: 0;
            filter: drop-shadow(0 2px 6px rgba(0,0,0,0.25));
        }
        .header-title-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-left: 18px;
        }
        .header h1 {
            color: #b40000;
            font-size: 2.1rem;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 0;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 24px;
            gap: 10px;
        }
        .tab-btn {
            background: #fff;
            color: #b40000;
            border: 2px solid #b40000;
            padding: 14px 38px;
            border-radius: 10px 10px 0 0;
            font-size: 1.15rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(180,0,0,0.04);
        }
        .tab-btn.active, .tab-btn:hover, .tab-btn:focus {
            background: #b40000;
            color: #fff;
            box-shadow: 0 4px 16px rgba(180,0,0,0.12);
            outline: none;
        }

        .main-content {
            background: none;
            border-radius: 0 0 18px 18px;
            box-shadow: none;
            padding: 0;
        }
        .tab-section {
            display: none;
            padding: 0;
        }
        .tab-section.active {
            display: block;
        }

        .card, .task-section, .photo-section {
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
            padding: 32px 24px;
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 2rem;
            margin-bottom: 28px;
            color: #b40000;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .task-form {
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #b40000;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #b40000;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
            color: #222;
            background: #fff;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #b40000;
        }

        .btn {
            background: #b40000;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(180,0,0,0.04);
        }

        .btn:hover, .btn:focus {
            background: #b40000;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(180,0,0,0.18);
            outline: none;
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #fff;
            color: #b40000;
            border: 2px solid #b40000;
        }
        .btn-secondary:hover, .btn-secondary:focus {
            background: #b40000;
            color: #fff;
        }

        .btn-success {
            background: #388e3c;
        }
        .btn-success:hover, .btn-success:focus {
            background: #2e7031;
        }

        .btn-danger {
            background: #b40000;
        }
        .btn-danger:hover, .btn-danger:focus {
            background: #b40000;
        }

        .task-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .task-item {
            background: #fff;
            border: 1.5px solid #b40000;
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 12px;
            transition: all 0.3s;
            color: #222;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .task-item.completed {
            background: #fbeaec;
            border-color: #b40000;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .task-title {
            font-weight: 700;
            color: #b40000;
        }

        .task-priority {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .priority-high, .priority-medium, .priority-low {
            background: #b40000;
            color: #fff;
            border: none;
            font-weight: 700;
            letter-spacing: 0.5px;
            padding: 4px 12px;
            font-size: 0.95rem;
            box-shadow: 0 2px 8px rgba(180,0,0,0.08);
        }

        .task-description {
            color: #222;
            margin-bottom: 10px;
        }

        .task-actions {
            display: flex;
            gap: 10px;
        }

        .task-actions button {
            padding: 6px 12px;
            font-size: 0.95rem;
        }

        .photo-capture {
            text-align: center;
            margin-bottom: 25px;
        }

        #video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        #canvas {
            display: none;
        }

        .photo-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(180,0,0,0.10);
        }

        .photo-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .photo-info {
            padding: 8px;
            background: rgba(180,0,0, 0.85);
            color: white;
            font-size: 0.9rem;
        }

        .location-info {
            background: #fff;
            border: 1px solid #b40000;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .location-info h4 {
            color: #b40000;
            margin-bottom: 10px;
        }

        .location-details {
            font-size: 0.95rem;
            color: #222;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 18px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: #fff;
            color: #b40000;
            padding: 28px 0;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.92;
        }

        @media (max-width: 900px) {
            .header {
                padding: 0 12px;
            }
        }
        @media (max-width: 768px) {
            .main-content {
                padding: 0;
            }
            .container {
                padding: 8px;
            }
            .tab-section {
                padding: 0;
            }
            .header h1 {
                font-size: 1.3rem;
            }
            .header-logo {
                height: 28px;
            }
            .header-title-group {
                margin-left: 8px;
            }
        }
        .btn.fill-out-btn, .btn.btn-success.fill-out-btn {
            background: linear-gradient(90deg, #b40000 0%, #ff7043 100%) !important;
            color: #fff !important;
            border: none;
            box-shadow: 0 4px 16px rgba(180,0,0,0.13);
            font-size: 1.08rem;
            letter-spacing: 0.5px;
            font-weight: 700;
            padding: 13px 32px;
            position: relative;
            overflow: hidden;
            transition: background 0.2s, box-shadow 0.2s, transform 0.18s;
        }
        .btn.fill-out-btn::before, .btn.btn-success.fill-out-btn::before {
            content: "\270E "; /* Pencil icon */
            font-size: 1.15em;
            margin-right: 7px;
            vertical-align: middle;
            opacity: 0.85;
        }
        .btn.fill-out-btn:hover, .btn.btn-success.fill-out-btn:hover {
            background: linear-gradient(90deg, #b40000 0%, #ff7043 100%) !important;
            box-shadow: 0 8px 24px rgba(180,0,0,0.18);
            transform: scale(1.045);
        }
        .btn.fill-out-btn:active, .btn.btn-success.fill-out-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="redstone-logo.png" alt="Redstone Logo" class="header-logo">
            <button id="syncBtn" class="btn" style="margin-left:auto;">Sync</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="tasksRemaining">0</div>
                <div class="stat-label">Tasks Remaining</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedTasks">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="performanceSummary">0%</div>
                <div class="stat-label">Performance</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" id="tabAllTasks">All Tasks</button>
            <button class="tab-btn" id="tabTasks">Custom Tasks</button>
            <button class="tab-btn" id="tabPhotos">Photos</button>
            <button class="tab-btn" id="tabVideo">Video Walkthrough</button>
        </div>
        <div class="main-content">
            <div class="tab-section active" id="allTasksTab">
                <div class="task-section">
                    <h2 class="section-title">Daily & Monthly Maintenance Checklist</h2>
                    <div class="task-list" id="allTaskList">
                        <!-- All daily/monthly tasks will be populated here -->
                    </div>
                </div>
            </div>
            <div class="tab-section" id="tasksTab">
                <div class="task-section">
                    <h2 class="section-title">Your Custom Tasks</h2>
                    <div class="task-list" id="taskList">
                        <!-- Custom tasks will be populated here -->
                    </div>
                    <div style="margin-top:32px;">
                        <h3 style="color:#b40000;">Add Your Own Task</h3>
                        <form class="task-form" id="taskForm">
                            <div class="form-group">
                                <label for="taskTitle">Task Title</label>
                                <input type="text" id="taskTitle" placeholder="Enter task title" required>
                            </div>
                            <button type="submit" class="btn">Add Custom Task</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="tab-section" id="photosTab">
                <div class="photo-section">
                    <h2 class="section-title">Photo Gallery</h2>
                    <div class="photo-gallery" id="photoGallery">
                        <!-- Photos will be rendered here -->
                    </div>
                </div>
            </div>
            <div class="tab-section" id="videoTab">
                <div class="photo-section">
                    <h2 class="section-title">Video Walkthrough</h2>
                    <div id="videoUploadSection">
                        <input type="file" id="videoInput" accept="video/*" style="display:none;" />
                        <button class="btn btn-secondary" id="chooseVideoBtn" type="button">Choose Video File</button>
                        <span id="videoFileName" style="margin-left:10px;color:#222;font-size:1rem;"></span>
                        <button class="btn" id="recordVideoBtn" type="button" style="margin-left:18px;">Record Video</button>
                        <button class="btn" id="uploadVideoBtn" style="margin-left:18px;">Upload Video</button>
                        <div id="videoUploadStatus" style="margin-top:10px;color:#b40000;"></div>
                        <div id="recordingControls" style="display:none;margin-top:16px;">
                            <video id="recordPreview" controls style="width:100%;max-width:400px;display:none;"></video>
                            <div style="margin-top:8px;">
                                <button class="btn btn-danger" id="stopRecordingBtn">Stop Recording</button>
                                <span id="recordingStatus" style="margin-left:12px;color:#b40000;font-weight:600;"></span>
                            </div>
                        </div>
                    </div>
                    <div id="uploadedVideoSection" style="display:none;margin-top:24px;">
                        <h3>Uploaded Video</h3>
                        <video id="uploadedVideo" controls style="width:100%;max-width:400px;"></video>
                    </div>
                    <div id="aiTasksSection" style="display:none;margin-top:24px;">
                        <h3>AI-Generated Tasks</h3>
                        <ul id="aiTasksList" style="padding-left:18px;"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Camera Modal for Task Photo Attachment -->
        <div id="cameraModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:2000;align-items:center;justify-content:center;">
            <div style="background:#fff;padding:24px;border-radius:12px;max-width:420px;width:95vw;position:relative;display:flex;flex-direction:column;align-items:center;">
                <button id="closeCameraModal" style="position:absolute;top:8px;right:8px;font-size:1.5rem;background:none;border:none;cursor:pointer;">&times;</button>
                <h3 style="color:#b40000;margin-bottom:12px;">Take Photo</h3>
                <video id="cameraVideo" autoplay style="width:100%;max-width:360px;border-radius:10px;"></video>
                <canvas id="cameraCanvas" style="display:none;"></canvas>
                <div style="margin:12px 0;">
                    <button class="btn" id="startCameraBtn">Start Camera</button>
                    <button class="btn btn-success" id="captureCameraPhoto" disabled>Take Photo</button>
                </div>
                <div id="cameraStatus" style="color:#b40000;font-size:0.95rem;"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Clear localStorage on next reload to ensure latest tasks
            localStorage.clear();
            console.log('DOM loaded, initializing app...');
            // --- Remove PREDEFINED_TASKS and period logic ---
            class MaintenanceTracker {
                constructor() {
                    this.tasks = JSON.parse(localStorage.getItem('maintenanceTasks')) || [];
                    this.photos = JSON.parse(localStorage.getItem('maintenancePhotos')) || [];
                    this.currentLocation = null;
                    this.stream = null;
                    this.activeTaskId = null;
                    this.initializeApp();
                }

                initializeApp() {
                    this.setupEventListeners();
                    this.renderAllTasks();
                    this.renderTasks();
                    this.renderPhotos();
                    this.updateStats();
                    this.getCurrentLocation();
                }

                getCurrentLocation() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            pos => {
                                this.currentLocation = {
                                    latitude: pos.coords.latitude,
                                    longitude: pos.coords.longitude,
                                    accuracy: pos.coords.accuracy
                                };
                            },
                            err => {
                                console.log('Location unavailable:', err);
                            },
                            { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                        );
                    }
                }

                setupEventListeners() {
                    document.getElementById('taskForm').addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.addTask();
                    });
                }

                addTask() {
                    const title = document.getElementById('taskTitle').value;
                    const task = {
                        id: Date.now(),
                        title,
                        details: [
                            { label: 'Description', type: 'textarea', required: false },
                            { label: 'Photo', type: 'photo', required: true }
                        ],
                        period: 'custom',
                        filled: {},
                        completed: false,
                        createdAt: new Date().toISOString(),
                        completedAt: null
                    };
                    this.tasks.push(task);
                    this.saveTasks();
                    this.renderTasks();
                    this.updateStats();
                    document.getElementById('taskForm').reset();
                }

                // --- Task Details Modal/Section ---
                showTaskDetails(id) {
                    const task = this.tasks.find(t => t.id === id);
                    if (!task) return;
                    this.activeTaskId = id;
                    // Create modal or expandable section
                    let modal = document.getElementById('taskDetailsModal');
                    if (!modal) {
                        modal = document.createElement('div');
                        modal.id = 'taskDetailsModal';
                        modal.style.position = 'fixed';
                        modal.style.top = '0';
                        modal.style.left = '0';
                        modal.style.width = '100vw';
                        modal.style.height = '100vh';
                        modal.style.background = 'rgba(0,0,0,0.4)';
                        modal.style.display = 'flex';
                        modal.style.alignItems = 'center';
                        modal.style.justifyContent = 'center';
                        modal.style.zIndex = '1000';
                        document.body.appendChild(modal);
                    }
                    // If the only detail is 'completed', show just the button
                    if (task.details.length === 1 && task.details[0].type === 'completed') {
                        modal.innerHTML = `<div style="background:#fff;padding:32px;border-radius:12px;max-width:500px;width:100%;position:relative;">
                            <button id="closeTaskDetails" style="position:absolute;top:8px;right:8px;font-size:1.5rem;background:none;border:none;cursor:pointer;">&times;</button>
                            <h2 style="color:#b40000;margin-bottom:16px;">${task.title}</h2>
                            <button class='btn btn-success' id='completeTaskBtn' style='margin-top:16px;width:100%;'>${task.completed ? 'Completed' : 'Mark as Complete'}</button>
                        </div>`;
                        modal.style.display = 'flex';
                        document.getElementById('closeTaskDetails').onclick = () => modal.style.display = 'none';
                        document.getElementById('completeTaskBtn').onclick = () => {
                            task.completed = true;
                            task.completedAt = new Date().toISOString();
                            this.saveTasks();
                            this.renderAllTasks();
                            this.renderTasks();
                            this.updateStats();
                            modal.style.display = 'none';
                        };
                        return;
                    }
                    modal.innerHTML = `<div style="background:#fff;padding:32px;border-radius:12px;max-width:500px;width:100%;position:relative;">
                        <button id="closeTaskDetails" style="position:absolute;top:8px;right:8px;font-size:1.5rem;background:none;border:none;cursor:pointer;">&times;</button>
                        <h2 style="color:#b40000;margin-bottom:16px;">${task.title}</h2>
                        <form id="taskDetailsForm">
                            ${task.details.map((d, i) => {
                                if (d.type === 'text') {
                                    return `<div class='form-group'><label>${d.label}${d.required ? ' *' : ''}</label><input type='text' name='${d.label}' value='${task.filled[d.label] || ''}' ${d.required ? 'required' : ''}></div>`;
                                } else if (d.type === 'textarea') {
                                    return `<div class='form-group'><label>${d.label}${d.required ? ' *' : ''}</label><textarea name='${d.label}' rows='2'>${task.filled[d.label] || ''}</textarea></div>`;
                                } else if (d.type === 'checkbox') {
                                    return `<div class='form-group'><label><input type='checkbox' name='${d.label}' ${task.filled[d.label] ? 'checked' : ''}> ${d.label}</label></div>`;
                                } else if (d.type === 'photo') {
                                    return `<div class='form-group'><label>${d.label}${d.required ? ' *' : ''}</label><button type='button' class='btn btn-secondary' onclick='tracker.openCameraForTask(${task.id}, "${d.label}")'>${task.filled[d.label] ? 'Retake Photo' : 'Attach Photo'}</button>${task.filled[d.label] ? '<span style=\"margin-left:8px;color:#388e3c;\">Photo attached</span>' : ''}${task.filled[d.label + '_location'] ? `<div style='font-size:0.85em;color:#888;'>Lat: ${task.filled[d.label + '_location'].latitude.toFixed(4)}, Lng: ${task.filled[d.label + '_location'].longitude.toFixed(4)}</div>` : ''}</div>`;
                                } else if (d.type === 'photos') {
                                    const photos = (task.filled[d.label] || []);
                                    return `<div class='form-group'>
                                        <button type='button' class='btn btn-secondary' onclick='tracker.openCameraForTask(${task.id}, "${d.label}", true)'>${photos.length > 0 ? 'Add More Photos' : 'Attach Photos'}</button>
                                        ${photos.length > 0 ? `<span style='margin-left:8px;color:#388e3c;'>${photos.length} photo${photos.length > 1 ? 's' : ''} attached</span>` : ''}
                                    </div>`;
                                }
                                return '';
                            }).join('')}
                            ${!task.details.some(d => d.label === 'Extra Details' && d.type === 'textarea') ? `<div class='form-group'><label>Extra Details</label><textarea name='Extra Details' rows='2'>${task.filled['Extra Details'] || ''}</textarea></div>` : ''}
                            <button type='submit' class='btn btn-success' style='margin-top:12px;'>Save Details</button>
                            <button type='button' class='btn btn-secondary' style='margin-top:12px;margin-left:8px;' id='closeTaskDetails2'>Cancel</button>
                        </form>
                        <button class='btn btn-success' id='completeTaskBtn' style='margin-top:16px;width:100%;' ${this.canCompleteTask(task) ? '' : 'disabled'}>${task.completed ? 'Completed' : 'Mark as Complete'}</button>
                    </div>`;
                    modal.style.display = 'flex';
                    document.getElementById('closeTaskDetails').onclick = () => modal.style.display = 'none';
                    document.getElementById('closeTaskDetails2').onclick = () => modal.style.display = 'none';
                    document.getElementById('taskDetailsForm').onsubmit = (e) => {
                        e.preventDefault();
                        const form = e.target;
                        task.details.forEach(d => {
                            if (d.type === 'text' || d.type === 'textarea') {
                                task.filled[d.label] = form[d.label].value;
                            } else if (d.type === 'checkbox') {
                                task.filled[d.label] = form[d.label].checked;
                            }
                            // Do NOT overwrite 'photo' or 'photos' fields here; they are set by the camera modal
                        });
                        // Save extra details
                        task.filled['Extra Details'] = form['Extra Details'].value;
                        this.saveTasks();
                        this.renderAllTasks();
                        this.renderTasks();
                        this.updateStats();
                        modal.style.display = 'none';
                    };
                    document.getElementById('completeTaskBtn').onclick = () => {
                        if (this.canCompleteTask(task)) {
                            task.completed = true;
                            task.completedAt = new Date().toISOString();
                            this.saveTasks();
                            this.renderAllTasks();
                            this.renderTasks();
                            this.updateStats();
                            modal.style.display = 'none';
                        }
                    };
                }

                canCompleteTask(task) {
                    // All required fields must be filled
                    return task.details.filter(d => d.required).every(d => {
                        if (d.type === 'checkbox') return true;
                        if (d.type === 'photos') return Array.isArray(task.filled[d.label]) && task.filled[d.label].length > 0;
                        return !!task.filled[d.label];
                    });
                }

                // Camera modal for photo attachment
                openCameraForTask(taskId, label, multiple) {
                    const cameraModal = document.getElementById('cameraModal');
                    const video = document.getElementById('cameraVideo');
                    const canvas = document.getElementById('cameraCanvas');
                    const startBtn = document.getElementById('startCameraBtn');
                    const captureBtn = document.getElementById('captureCameraPhoto');
                    const status = document.getElementById('cameraStatus');
                    let stream = null;
                    let currentLocation = null;
                    cameraModal.style.display = 'flex';
                    video.style.display = 'block';
                    canvas.style.display = 'none';
                    captureBtn.disabled = true;
                    status.textContent = '';
                    // Get location
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            pos => {
                                currentLocation = {
                                    latitude: pos.coords.latitude,
                                    longitude: pos.coords.longitude,
                                    accuracy: pos.coords.accuracy
                                };
                            },
                            err => {
                                status.textContent = 'Location unavailable.';
                            },
                            { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                        );
                    } else {
                        status.textContent = 'Geolocation not supported.';
                    }
                    // Camera logic
                    startBtn.onclick = async () => {
                        try {
                            stream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 1280 }, height: { ideal: 720 } } });
                            video.srcObject = stream;
                            captureBtn.disabled = false;
                            status.textContent = '';
                        } catch (e) {
                            status.textContent = 'Unable to access camera.';
                        }
                    };
                    captureBtn.onclick = () => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        canvas.getContext('2d').drawImage(video, 0, 0);
                        const photoData = canvas.toDataURL('image/jpeg');
                        // Save photo and location to task
                        const task = this.tasks.find(t => t.id === taskId);
                        if (task) {
                            if (multiple) {
                                if (!task.filled[label]) {
                                    task.filled[label] = [];
                                }
                                task.filled[label].push({
                                    data: photoData,
                                    taskId: task.id,
                                    taskTitle: task.title,
                                    label: label,
                                    location: currentLocation || null,
                                    createdAt: new Date().toISOString()
                                });
                            } else {
                                task.filled[label] = photoData;
                            }
                            if (currentLocation) {
                                task.filled[label + '_location'] = currentLocation;
                            }
                            // Add to gallery
                            this.addPhotoToGallery({
                                data: photoData,
                                taskId: task.id,
                                taskTitle: task.title,
                                label: label,
                                location: currentLocation || null,
                                createdAt: new Date().toISOString()
                            });
                            this.saveTasks();
                            this.renderAllTasks();
                            this.renderTasks();
                            this.renderPhotos();
                        }
                        status.textContent = 'Photo attached!';
                        setTimeout(() => {
                            cameraModal.style.display = 'none';
                            if (stream) {
                                stream.getTracks().forEach(track => track.stop());
                            }
                            // Re-render the task details modal so the user can immediately mark as complete
                            if (window.tracker && typeof window.tracker.showTaskDetails === 'function') {
                                window.tracker.showTaskDetails(taskId);
                            }
                        }, 1000);
                    };
                    document.getElementById('closeCameraModal').onclick = () => {
                        cameraModal.style.display = 'none';
                        if (stream) {
                            stream.getTracks().forEach(track => track.stop());
                        }
                    };
                }

                renderAllTasks() {
                    const allTaskList = document.getElementById('allTaskList');
                    allTaskList.innerHTML = '';
                    if (this.tasks.length === 0) {
                        allTaskList.innerHTML = `<div style='color:#888;margin:12px 0;'>No tasks yet. Upload a video to generate tasks.</div>`;
                        return;
                    }
                    this.tasks.forEach(task => {
                        const taskElement = document.createElement('div');
                        taskElement.className = `task-item ${task.completed ? 'completed' : ''}`;
                        taskElement.innerHTML = `
                            <div class="task-header">
                                <span class="task-title">${task.title}</span>
                                <span class="frequency-label" style="background:#b40000;color:#fff;padding:4px 12px;border-radius:6px;font-size:0.95rem;font-weight:600;margin-left:10px;">${task.frequency ? task.frequency.charAt(0).toUpperCase() + task.frequency.slice(1) : ''}</span>
                            </div>
                            <div class="task-description">${task.details.filter(d => d.type !== 'completed').map(d => d.label).join(', ')}</div>
                            <div class="task-actions">
                                <button class="btn btn-success fill-out-btn" data-taskid="${task.id}">${task.completed ? 'View' : 'Fill Out'}</button>
                            </div>
                        `;
                        allTaskList.appendChild(taskElement);
                    });
                }

                renderTasks() {
                    const taskList = document.getElementById('taskList');
                    taskList.innerHTML = '';
                    // Only show custom tasks that are not completed
                    const customTasks = this.tasks.filter(t => t.period === 'custom' && !t.completed);
                    const section = document.createElement('div');
                    section.innerHTML = `<h3 style='color:#b40000;margin:16px 0 8px 0;'>Custom Tasks</h3>`;
                    if (customTasks.length === 0) {
                        section.innerHTML += `<div style='color:#888;margin:12px 0;'>No custom tasks yet. Add one below!</div>`;
                    }
                    customTasks.forEach(task => {
                        const taskElement = document.createElement('div');
                        taskElement.className = `task-item ${task.completed ? 'completed' : ''}`;
                        taskElement.innerHTML = `
                            <div class="task-header">
                                <span class="task-title">${task.title}</span>
                                <span class="task-priority priority-low">Custom</span>
                            </div>
                            <div class="task-description">${(() => {
                                if (task.details.some(d => d.type === 'photos')) return 'Photos';
                                if (task.details.some(d => d.type === 'photo')) return 'Photo';
                                return task.details.filter(d => d.type !== 'completed').map(d => d.label).join(', ');
                            })()}</div>
                            <div class="task-actions">
                                <button class="btn btn-success fill-out-btn" data-taskid="${task.id}">${task.completed ? 'View' : 'Fill Out'}</button>
                                <button class="btn btn-danger" data-deleteid="${task.id}">Delete</button>
                            </div>
                        `;
                        section.appendChild(taskElement);
                    });
                    taskList.appendChild(section);
                }

                deleteTask(id) {
                    this.tasks = this.tasks.filter(t => t.id !== id);
                    this.saveTasks();
                    this.renderAllTasks();
                    this.renderTasks();
                    this.updateStats();
                }

                updateStats() {
                    const remaining = this.tasks.filter(t => !t.completed).length;
                    document.getElementById('tasksRemaining').textContent = remaining;
                    document.getElementById('completedTasks').textContent = this.tasks.filter(t => t.completed).length;
                    // Performance summary
                    const total = this.tasks.length;
                    const completed = this.tasks.filter(t => t.completed).length;
                    document.getElementById('performanceSummary').textContent = total > 0 ? Math.round((completed / total) * 100) + '%' : '0%';
                }

                saveTasks() {
                    localStorage.setItem('maintenanceTasks', JSON.stringify(this.tasks));
                }

                addPhotoToGallery(photo) {
                    this.photos.push(photo);
                    localStorage.setItem('maintenancePhotos', JSON.stringify(this.photos));
                }

                deletePhotoFromGallery(index) {
                    this.photos.splice(index, 1);
                    localStorage.setItem('maintenancePhotos', JSON.stringify(this.photos));
                    this.renderPhotos();
                }

                renderPhotos() {
                    const gallery = document.getElementById('photoGallery');
                    if (!gallery) return;
                    gallery.innerHTML = '';
                    if (this.photos.length === 0) {
                        gallery.innerHTML = `<div style='color:#888;margin:12px 0;'>No photos yet. Attach photos to tasks to see them here!</div>`;
                        return;
                    }
                    this.photos.slice().reverse().forEach((photo, idx) => {
                        const i = this.photos.length - 1 - idx;
                        const item = document.createElement('div');
                        item.className = 'photo-item';
                        item.innerHTML = `
                            <img src="${photo.data}" alt="Task Photo">
                            <div class="photo-info">
                                <div><strong>${photo.taskTitle}</strong></div>
                                <div style="font-size:0.85em;">${photo.label}</div>
                                ${photo.location ? `<div style='font-size:0.85em;'>Lat: ${photo.location.latitude.toFixed(4)}, Lng: ${photo.location.longitude.toFixed(4)}</div>` : ''}
                                <button class="btn btn-danger" style="margin-top:6px;" data-deleteidx="${i}">Delete</button>
                            </div>
                        `;
                        gallery.appendChild(item);
                    });
                }
            }

            // Initialize the app
            console.log('Creating MaintenanceTracker...');
            window.tracker = new MaintenanceTracker();
            console.log('MaintenanceTracker created, setting up event listeners...');

            // Tab switching logic and delegated event listeners (set up immediately after tracker is created)
            function setActiveTab(tab) {
                // Remove active from all
                document.getElementById('tabAllTasks').classList.remove('active');
                document.getElementById('tabTasks').classList.remove('active');
                document.getElementById('tabPhotos').classList.remove('active');
                document.getElementById('tabVideo').classList.remove('active');
                document.getElementById('allTasksTab').classList.remove('active');
                document.getElementById('tasksTab').classList.remove('active');
                document.getElementById('photosTab').classList.remove('active');
                document.getElementById('videoTab').classList.remove('active');
                // Set active
                if (tab === 'all') {
                    document.getElementById('tabAllTasks').classList.add('active');
                    document.getElementById('allTasksTab').classList.add('active');
                } else if (tab === 'custom') {
                    document.getElementById('tabTasks').classList.add('active');
                    document.getElementById('tasksTab').classList.add('active');
                } else if (tab === 'photos') {
                    document.getElementById('tabPhotos').classList.add('active');
                    document.getElementById('photosTab').classList.add('active');
                    if (window.tracker) window.tracker.renderPhotos();
                } else if (tab === 'video') {
                    document.getElementById('tabVideo').classList.add('active');
                    document.getElementById('videoTab').classList.add('active');
                }
            }
            document.getElementById('tabAllTasks').addEventListener('click', function() {
                console.log('All Tasks tab clicked');
                setActiveTab('all');
            });
            document.getElementById('tabTasks').addEventListener('click', function() {
                console.log('Custom Tasks tab clicked');
                setActiveTab('custom');
            });
            document.getElementById('tabPhotos').addEventListener('click', function() {
                console.log('Photos tab clicked');
                setActiveTab('photos');
            });
            document.getElementById('tabVideo').addEventListener('click', function() {
                console.log('Video Walkthrough tab clicked');
                setActiveTab('video');
            });
            // Delegated event listeners for Fill Out/View buttons
            document.getElementById('allTaskList').addEventListener('click', function(e) {
                if (e.target.classList.contains('fill-out-btn')) {
                    const taskId = e.target.getAttribute('data-taskid');
                    if (window.tracker) window.tracker.showTaskDetails(Number(taskId));
                }
            });
            document.getElementById('taskList').addEventListener('click', function(e) {
                if (e.target.classList.contains('fill-out-btn')) {
                    const taskId = e.target.getAttribute('data-taskid');
                    if (window.tracker) window.tracker.showTaskDetails(Number(taskId));
                }
                if (e.target.hasAttribute('data-deleteid')) {
                    const taskId = e.target.getAttribute('data-deleteid');
                    if (window.tracker) window.tracker.deleteTask(Number(taskId));
                }
            });
            // Delegated event for deleting photos
            document.getElementById('photoGallery').addEventListener('click', function(e) {
                if (e.target.hasAttribute('data-deleteidx')) {
                    const idx = Number(e.target.getAttribute('data-deleteidx'));
                    if (window.tracker) window.tracker.deletePhotoFromGallery(idx);
                }
            });

            // Sync button logic
            document.getElementById('syncBtn').addEventListener('click', async function() {
                const btn = this;
                btn.disabled = true;
                btn.textContent = 'Syncing...';
                try {
                    // Gather all tasks and photos
                    const tasks = window.tracker.tasks;
                    const photos = window.tracker.photos;
                    // Send to backend
                    const resp = await fetch('http://localhost:5000/sync', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tasks, photos })
                    });
                    if (resp.ok) {
                        btn.textContent = 'Synced!';
                        setTimeout(() => { btn.textContent = 'Sync'; btn.disabled = false; }, 1200);
                    } else {
                        btn.textContent = 'Sync Failed';
                        setTimeout(() => { btn.textContent = 'Sync'; btn.disabled = false; }, 2000);
                    }
                } catch (e) {
                    btn.textContent = 'Sync Failed';
                    setTimeout(() => { btn.textContent = 'Sync'; btn.disabled = false; }, 2000);
                }
            });

            // Video upload logic
            const videoInput = document.getElementById('videoInput');
            const chooseVideoBtn = document.getElementById('chooseVideoBtn');
            const videoFileName = document.getElementById('videoFileName');
            const recordVideoBtn = document.getElementById('recordVideoBtn');
            const uploadVideoBtn = document.getElementById('uploadVideoBtn');
            const videoUploadStatus = document.getElementById('videoUploadStatus');
            const recordingControls = document.getElementById('recordingControls');
            const recordPreview = document.getElementById('recordPreview');
            const stopRecordingBtn = document.getElementById('stopRecordingBtn');
            const recordingStatus = document.getElementById('recordingStatus');
            const uploadedVideoSection = document.getElementById('uploadedVideoSection');
            const uploadedVideo = document.getElementById('uploadedVideo');
            const aiTasksSection = document.getElementById('aiTasksSection');
            const aiTasksList = document.getElementById('aiTasksList');
            let uploadedVideoUrl = null;
            let recordedBlob = null;
            let mediaRecorder = null;
            let recordedChunks = [];
            let selectedFile = null;

            chooseVideoBtn.addEventListener('click', function() {
                videoInput.click();
            });
            videoInput.addEventListener('change', function() {
                if (videoInput.files && videoInput.files.length > 0) {
                    selectedFile = videoInput.files[0];
                    videoFileName.textContent = selectedFile.name;
                    recordedBlob = null;
                    recordPreview.style.display = 'none';
                } else {
                    videoFileName.textContent = '';
                    selectedFile = null;
                }
            });

            recordVideoBtn.addEventListener('click', async function() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    videoUploadStatus.textContent = 'Camera not supported on this device.';
                    return;
                }
                videoUploadStatus.textContent = '';
                recordingControls.style.display = 'block';
                recordPreview.style.display = 'none';
                recordedChunks = [];
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = function(e) {
                        if (e.data.size > 0) recordedChunks.push(e.data);
                    };
                    mediaRecorder.onstop = function() {
                        recordedBlob = new Blob(recordedChunks, { type: 'video/webm' });
                        recordPreview.src = URL.createObjectURL(recordedBlob);
                        recordPreview.style.display = 'block';
                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                        videoFileName.textContent = 'Recorded Video';
                        selectedFile = null;
                    };
                    mediaRecorder.start();
                    recordingStatus.textContent = 'Recording...';
                    stopRecordingBtn.disabled = false;
                } catch (e) {
                    videoUploadStatus.textContent = 'Could not start camera.';
                    recordingControls.style.display = 'none';
                }
            });

            stopRecordingBtn.addEventListener('click', function() {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    recordingStatus.textContent = 'Recording stopped.';
                    stopRecordingBtn.disabled = true;
                }
            });

            uploadVideoBtn.addEventListener('click', async function() {
                let fileToUpload = null;
                if (recordedBlob) {
                    fileToUpload = new File([recordedBlob], 'recorded_video.webm', { type: 'video/webm' });
                } else if (selectedFile) {
                    fileToUpload = selectedFile;
                }
                if (!fileToUpload) {
                    videoUploadStatus.textContent = 'Please select or record a video.';
                    return;
                }
                videoUploadStatus.textContent = 'Uploading...';
                const formData = new FormData();
                formData.append('video', fileToUpload);
                try {
                    const resp = await fetch('http://localhost:5000/upload_video', {
                        method: 'POST',
                        body: formData
                    });
                    if (resp.ok) {
                        const data = await resp.json();
                        videoUploadStatus.textContent = 'Upload successful!';
                        // Show video
                        uploadedVideoSection.style.display = 'block';
                        uploadedVideo.src = data.video_url;
                        uploadedVideoUrl = data.video_url;
                        // Show AI tasks if available
                        if (data.ai_tasks && data.ai_tasks.length > 0) {
                            aiTasksSection.style.display = 'block';
                            aiTasksList.innerHTML = '';
                            data.ai_tasks.forEach(task => {
                                const li = document.createElement('li');
                                li.textContent = task;
                                aiTasksList.appendChild(li);
                            });
                            // --- NEW: Replace localStorage tasks with AI-generated tasks ---
                            const photoRequiredKeywords = [
                              "clean", "debris", "trash", "stain", "mop", "sweep", "remove", "empty", "wipe",
                              "inspect", "visible", "show", "proof", "photo", "picture", "leak", "damage",
                              "repair", "fix", "replace", "organize", "tidy", "clear", "unclog", "restock",
                              "refill", "replenish", "sanitize", "disinfect"
                            ];
                            const frequencyKeywords = [
                              { keywords: ["every day", "daily"], frequency: "daily" },
                              { keywords: ["every week", "weekly"], frequency: "weekly" },
                              { keywords: ["every month", "monthly"], frequency: "monthly" },
                              { keywords: ["every quarter", "quarterly"], frequency: "quarterly" },
                              { keywords: ["every year", "annually", "annual", "yearly"], frequency: "annually" }
                            ];
                            function getFrequency(title) {
                              const lower = title.toLowerCase();
                              for (const { keywords, frequency } of frequencyKeywords) {
                                if (keywords.some(kw => lower.includes(kw))) return frequency;
                              }
                              return "daily"; // default
                            }
                            const aiTasks = data.ai_tasks.map((title, idx) => {
                              const needsPhoto = photoRequiredKeywords.some(kw =>
                                title.toLowerCase().includes(kw)
                              );
                              const frequency = getFrequency(title);
                              return {
                                id: Date.now() + idx,
                                title,
                                details: [
                                  { label: 'Extra Details', type: 'textarea', required: false },
                                  { label: 'Photo', type: 'photo', required: needsPhoto }
                                ],
                                period: 'custom',
                                frequency: frequency,
                                filled: {},
                                completed: false,
                                createdAt: new Date().toISOString(),
                                completedAt: null
                              };
                            });
                            localStorage.setItem('maintenanceTasks', JSON.stringify(aiTasks));
                            if (window.tracker) {
                                window.tracker.tasks = aiTasks;
                                window.tracker.renderAllTasks();
                                window.tracker.updateStats();
                            }
                        } else {
                            aiTasksSection.style.display = 'none';
                        }
                    } else {
                        videoUploadStatus.textContent = 'Upload failed.';
                    }
                } catch (e) {
                    videoUploadStatus.textContent = 'Upload failed.';
                }
            });
        }); // End of DOMContentLoaded

        // Helper for weekly reset
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
            return weekNo;
        }
    </script>
</body>
</html> 